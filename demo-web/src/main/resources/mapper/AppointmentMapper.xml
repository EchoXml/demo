<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.echo.dao.AppointmentDao">
	<insert id="insertAppointment">
		<!-- ignore 主键冲突，报错 -->
		INSERT ignore INTO appointment (book_id, user_id)
		VALUES (#{bookId}, #{userId})
	</insert>

<!-- 	<select id="queryByKeyWithBook" resultType="appointment">
		如何告诉MyBatis把结果映射到Appointment同时映射book属性
		可以自由控制SQL
		SELECT
		a.book_id,
		a.user_id,
		a.appoint_time,
		b.book_id "book.book_id",
		b.`name` "book.name",
		b.number "book.number"
		FROM
		appointment a
		INNER JOIN book b ON a.book_id = b.book_id
		WHERE
		a.book_id = #{bookId}
		AND a.user_id = #{userId}
	</select> -->
	
	
	<!-- 根据bookId查询所有预约信息 -->
	<select id="queryAppointmentsByBookId" resultType="appointment">
		select *
		from appointment
		where book_id=#{bookId}
	</select>
	
	<!--删除对应预约记录  -->
	<delete id="delAppointById">
		delete from appointment WHERE book_id=#{bookId} and user_id=#{userId}
	</delete>
	
	<!-- 根据userId查询所有预约信息 -->
	<select id="queryAppointmentsByUserId" resultType="appointment">
		SELECT
		a.book_id,
		a.user_id,
		a.appoint_time,
		a.state,
		a.return_time,
		b.book_id "book.book_id",
		b.`name` "book.name",
		b.number "book.number",
		u.username "userInfo.username",
		u.nickname "userInfo.nickname"
		FROM
		appointment a
		INNER JOIN book b ON a.book_id = b.book_id inner join userinfo u on u.user_id=a.user_id
			<if test="userId!=null">
			<where>
				a.user_id=#{userId}
			</where>
			</if>
	</select>
	
	<!-- 更新预约记录信息 -->
	<update id="updateAppoint" parameterType="appointment">
		update appointment
		<set>
			<if test="returnTime!=null">
				return_Time=#{returnTime},
			</if>
			<if test="state!=null">
				state=#{state}
			</if>
		</set> 
		<where>
			<if test="userId!=null">
				user_Id=#{userId}
			</if>
			<if test="bookId!=null">
				and book_id=#{bookId}
			</if>
			<if test="appointTime!=null">
				and appoint_Time=#{appointTime}
			</if>
		</where>
	</update>
</mapper>